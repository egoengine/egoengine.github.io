<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EgoEngine — global swipe</title>
<style>
  :root { --divider-x: 50vw; --bg:#0b0b0c; --line:rgba(255,255,255,.95); }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:#eaeaea;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* Wordmark stays below divider (z-index lower than the divider). */
  .brand{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:3;pointer-events:none}
  .brand .wordmark{
    font-weight:900;font-size:clamp(42px,10vw,120px);line-height:1;
    background:linear-gradient(180deg,#fff,#dfe5ff);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 10px 32px rgba(0,0,0,.45);
  }

  /* Always 6 columns (=> 3 rows for 18 tiles), no responsive column changes */
  .grid{
    display:grid;
    grid-template-columns:repeat(6, minmax(0,1fr));
    gap:0;
    width:100vw;
    max-width:100vw;
    margin:0 auto;
  }

  .tile{ position:relative; aspect-ratio:1/1; overflow:hidden; background:#000; }
  .tile video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; background:#000; }
  .tile video.base{ z-index:1; }         /* inpainted (right side)  */
  .tile video.overlay{ z-index:2;         /* cropped (left side)    */
    clip-path: polygon(0 0, var(--cut,0px) 0, var(--cut,0px) 100%, 0 100%);
    will-change:clip-path;
  }

  /* Divider above everything. Remove transform (which creates its own stacking context in some browsers)
     and place it precisely with left: calc(...). Crank z-index way up. */
  #divider{
    position:fixed; top:0; bottom:0;
    left: calc(var(--divider-x) - 1px);
    width:2px; background:var(--line);
    pointer-events:none; z-index:9999;
  }
</style>
</head>
<body>
  <div class="brand"><div class="wordmark">EgoEngine</div></div>
  <div id="divider"></div>
  <main id="grid" class="grid"></main>

<script>
  const ROOT = 'videos/blending/human';
  const FOLDERS = [
    'Cassie-bartending','Cassie-bartending2','Cassie-blinds','Cassie-boardgame','Cassie-cat2','Cassie-cat_food',
    'Cassie-cooking2','Cassie-door','Cassie-earbuds','Cassie-eyedrops','Cassie-flower','Cassie-fridge',
    'Cassie-laptop','Cassie-microwave','Cassie-oven','Cassie-subway','Cassie-yogurt','Cassie-Rowan-Allen',
  ];

  function makeVideo(src, cls){
    const v = document.createElement('video');
    v.className = cls || '';
    v.autoplay = true; v.loop = true; v.muted = true; v.playsInline = true;
    v.setAttribute('muted',''); v.setAttribute('playsinline','');
    v.preload = 'auto';
    v.src = src;
    const tryPlay = () => v.play().catch(()=>{});
    v.addEventListener('canplay', tryPlay);
    v.addEventListener('loadeddata', tryPlay);
    v.addEventListener('mouseenter', tryPlay);
    v.addEventListener('touchstart', tryPlay, {passive:true});
    v.addEventListener('ended', () => { v.currentTime = 0; tryPlay(); });
    return v;
  }

  const grid = document.getElementById('grid');

  // Build tiles
  (function build(){
    for (const name of FOLDERS){
      const tile = document.createElement('div'); tile.className = 'tile';
      const base = makeVideo(`${ROOT}/${name}/inpainted_video.mp4`, 'base');
      const over = makeVideo(`${ROOT}/${name}/cropped_video.mp4`,   'overlay');
      tile.append(base, over);
      grid.appendChild(tile);
    }
    requestAnimationFrame(()=>{ updateDivider(); updateClips(); updatePlayback(); });
  })();

  // Global swipe divider
  let cutX = Math.round(window.innerWidth * 0.5);

  function updateDivider(){
    document.documentElement.style.setProperty('--divider-x', cutX + 'px');
  }

  function updateClips(){
    document.querySelectorAll('.tile').forEach(tile=>{
      const r = tile.getBoundingClientRect();
      const local = Math.max(0, Math.min(r.width, cutX - r.left)); // px of overlay visible in this tile
      tile.style.setProperty('--cut', local + 'px');
    });
  }

  // Play only what’s visible in each tile to keep decoders ≤ ~18
  function setPlaying(v, shouldPlay){
    if (!v) return;
    if (shouldPlay) { if (v.paused) v.play().catch(()=>{}); }
    else { if (!v.paused) v.pause(); }
  }
  function updatePlayback(){
    document.querySelectorAll('.tile').forEach(tile=>{
      const base = tile.querySelector('video.base');
      const over = tile.querySelector('video.overlay');
      const r = tile.getBoundingClientRect();
      const cutLocal = Math.max(0, Math.min(r.width, cutX - r.left));
      const showOver = cutLocal > 0;       // some left part shown
      const showBase = cutLocal < r.width; // some right part shown
      setPlaying(over, showOver);
      setPlaying(base, showBase);
    });
  }

  function setCutFrom(x){
    cutX = Math.max(0, Math.min(window.innerWidth, x));
    updateDivider(); updateClips(); updatePlayback();
  }

  window.addEventListener('mousemove', e => setCutFrom(e.clientX));
  window.addEventListener('touchstart', e => e.touches[0] && setCutFrom(e.touches[0].clientX), {passive:true});
  window.addEventListener('touchmove',  e => e.touches[0] && setCutFrom(e.touches[0].clientX), {passive:true});
  window.addEventListener('resize',     () => { updateDivider(); updateClips(); updatePlayback(); });
  document.addEventListener('visibilitychange', ()=>{
    if (!document.hidden) document.querySelectorAll('video').forEach(v=> v.play().catch(()=>{}));
  });
</script>
</body>
</html>
